{"version":3,"file":"DisTubeStream.js","sourceRoot":"","sources":["../../src/core/DisTubeStream.ts"],"names":[],"mappings":"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","sourcesContent":["import { isURL } from \"..\";\nimport { FFmpeg } from \"prism-media\";\nimport { DisTubeError } from \"../struct\";\nimport { StreamType } from \"@discordjs/voice\";\nimport type ytdl from \"@distube/ytdl-core\";\n\ninterface StreamOptions {\n  /**\n   * Time to seek in seconds\n   */\n  seek?: number;\n  /**\n   * Additional FFmpeg arguments\n   */\n  ffmpegArgs?: string[];\n  /**\n   * If the stream url is live\n   */\n  isLive?: boolean;\n}\n\nexport const chooseBestVideoFormat = (formats: ytdl.videoFormat[], isLive = false) => {\n  let filter = (format: ytdl.videoFormat) => format.hasAudio;\n  if (isLive) filter = (format: ytdl.videoFormat) => format.hasAudio && format.isHLS;\n  formats = formats\n    .filter(filter)\n    .sort((a, b) => Number(b.audioBitrate) - Number(a.audioBitrate) || Number(a.bitrate) - Number(b.bitrate));\n  return formats.find(format => !format.hasVideo) || formats.sort((a, b) => Number(a.bitrate) - Number(b.bitrate))[0];\n};\n\n/**\n * Create a stream to play with {@link DisTubeVoice}\n * @private\n */\nexport class DisTubeStream {\n  /**\n   * Create a stream from ytdl video formats\n   * @param {ytdl.videoFormat[]} formats ytdl video formats\n   * @param {StreamOptions} options options\n   * @returns {DisTubeStream}\n   * @private\n   */\n  static YouTube(formats: ytdl.videoFormat[] | undefined, options: StreamOptions = {}): DisTubeStream {\n    if (!formats || !formats.length) throw new DisTubeError(\"UNAVAILABLE_VIDEO\");\n    if (!options || typeof options !== \"object\" || Array.isArray(options)) {\n      throw new DisTubeError(\"INVALID_TYPE\", \"object\", options, \"options\");\n    }\n    const bestFormat = chooseBestVideoFormat(formats, options.isLive);\n    if (!bestFormat) throw new DisTubeError(\"UNPLAYABLE_FORMATS\");\n    return new DisTubeStream(bestFormat.url, options);\n  }\n  /**\n   * Create a stream from a stream url\n   * @param {string} url stream url\n   * @param {StreamOptions} options options\n   * @returns {DisTubeStream}\n   * @private\n   */\n  static DirectLink(url: string, options: StreamOptions = {}): DisTubeStream {\n    if (!options || typeof options !== \"object\" || Array.isArray(options)) {\n      throw new DisTubeError(\"INVALID_TYPE\", \"object\", options, \"options\");\n    }\n    if (typeof url !== \"string\" || !isURL(url)) {\n      throw new DisTubeError(\"INVALID_TYPE\", \"an URL\", url);\n    }\n    return new DisTubeStream(url, options);\n  }\n  type: StreamType.Raw;\n  stream: FFmpeg;\n  url: string;\n  /**\n   * Create a DisTubeStream to play with {@link DisTubeVoice}\n   * @param {string} url Stream URL\n   * @param {StreamOptions} options Stream options\n   * @private\n   */\n  constructor(url: string, options: StreamOptions) {\n    /**\n     * Stream URL\n     * @type {string}\n     */\n    this.url = url;\n    /**\n     * Stream type\n     * @type {DiscordVoice.StreamType.Raw}\n     */\n    this.type = StreamType.Raw;\n    const args = [\n      \"-reconnect\",\n      \"1\",\n      \"-reconnect_streamed\",\n      \"1\",\n      \"-reconnect_delay_max\",\n      \"5\",\n      \"-i\",\n      url,\n      \"-analyzeduration\",\n      \"0\",\n      \"-loglevel\",\n      \"0\",\n      \"-ar\",\n      \"48000\",\n      \"-ac\",\n      \"2\",\n      \"-f\",\n      \"s16le\",\n    ];\n    if (typeof options.seek === \"number\" && options.seek > 0) {\n      args.unshift(\"-ss\", options.seek.toString());\n    }\n    if (Array.isArray(options.ffmpegArgs)) {\n      args.push(...options.ffmpegArgs);\n    }\n    /**\n     * FFmpeg stream (Duplex)\n     * @type {FFmpeg}\n     */\n    this.stream = new FFmpeg({ args, shell: false });\n  }\n}\n"]}